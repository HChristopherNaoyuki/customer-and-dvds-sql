-- QUESTION 1
-- CREATE DATABASE: StudentNumber_DATA6212_ExamQ1
CREATE DATABASE StudentNumber_DATA6212_ExamQ1;

USE StudentNumber_DATA6212_ExamQ1;

-- PRELOAD
-- TABLES
CREATE TABLE CUSTOMERS
(
    CUSTOMER_ID VARCHAR(10) NOT NULL PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(50) NOT NULL
);

CREATE TABLE VENUES
(
    VENUE_CODE VARCHAR(5) NOT NULL PRIMARY KEY,
    VENUE_NAME VARCHAR(50) NOT NULL,
    ADDRESS VARCHAR(50) NOT NULL,
    CITY VARCHAR(50) NOT NULL,
    MAX_CAPACITY SMALLINT NOT NULL
);

CREATE TABLE ACCOMMODATION_BOOKINGS
(
    CUSTOMER_ID VARCHAR(10) NOT NULL,
    VENUE_CODE VARCHAR(5) NOT NULL,
    CHECKIN_DATE DATE NOT NULL,
    NIGHTS SMALLINT NOT NULL,
    RATE SMALLMONEY NOT NULL,

    -- CONSTRAINTS
    PRIMARY KEY (CUSTOMER_ID, VENUE_CODE, CHECKIN_DATE),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(CUSTOMER_ID),
    FOREIGN KEY (VENUE_CODE) REFERENCES VENUES(VENUE_CODE)
);

-- POPULATE TABLES
INSERT INTO CUSTOMERS (CUSTOMER_ID, CUSTOMER_NAME)
VALUES
('123456', 'Neo Petlele'),
('246810', 'Derek Moore'),
('369121', 'Pedro Ntaba'),
('654321', 'Thabo Joe'),
('987654', 'Dominique Woolrigde');

INSERT INTO VENUES (VENUE_CODE, VENUE_NAME, ADDRESS, CITY, MAX_CAPACITY)
VALUES
('V0001', 'Durbs Bed and Breakfast', '12 Radar Drive', 'Durban', 2),
('V0002', 'Jacaranda Guesthouse', '116 Clearwater Road', 'Tshwane', 6),
('V0003', 'Sandton Sun', '1 Waterstone Drive', 'Sandton', 4),
('V0004', 'Friendly City Hotel', '2 Ring Road', 'Port Elizabeth', 4),
('V0005', 'Belmont Self Catering', '1 Belmont Road', 'Cape Town', 10);

-- CORRECTED: Year updated to 2020 for accurate filtering in Q1.1
INSERT INTO ACCOMMODATION_BOOKINGS (CUSTOMER_ID, VENUE_CODE, CHECKIN_DATE, NIGHTS, RATE)
VALUES
('123456', 'V0001', '2020-10-30', 3, 1500.00),
('246810', 'V0005', '2020-10-29', 2, 980.00),
('246810', 'V0004', '2020-10-30', 5, 1100.00),
('654321', 'V0002', '2020-10-28', 1, 1350.00),
('987654', 'V0001', '2020-10-29', 7, 1300.00),
('123456', 'V0002', '2020-10-20', 3, 1350.00),
('246810', 'V0003', '2020-10-29', 4, 2100.00);

-- Q.1.1. CREATE VIEW: ExtendedBookings
-- CORRECTED: Year filter now matches dataset (2020)
CREATE VIEW ExtendedBookings AS
SELECT 
    VENUE_CODE, 
    CUSTOMER_ID, 
    CHECKIN_DATE, 
    NIGHTS
FROM ACCOMMODATION_BOOKINGS
WHERE YEAR(CHECKIN_DATE) = 2020
AND NIGHTS >= 5;

-- VIEW RESULTS
SELECT * FROM ExtendedBookings;

-- Q.1.2. CREATE PROCEDURE: FindVenueBookings
CREATE PROCEDURE FindVenueBookings
    @VenueCode VARCHAR(5)
AS
BEGIN
    SELECT 
        VENUES.VENUE_NAME, 
        CUSTOMERS.CUSTOMER_NAME, 
        ACCOMMODATION_BOOKINGS.CHECKIN_DATE, 
        ACCOMMODATION_BOOKINGS.NIGHTS
    FROM ACCOMMODATION_BOOKINGS
    INNER JOIN VENUES 
        ON ACCOMMODATION_BOOKINGS.VENUE_CODE = VENUES.VENUE_CODE
    INNER JOIN CUSTOMERS 
        ON ACCOMMODATION_BOOKINGS.CUSTOMER_ID = CUSTOMERS.CUSTOMER_ID
    WHERE ACCOMMODATION_BOOKINGS.VENUE_CODE = @VenueCode;
END;
GO

-- EXECUTE STORED PROCEDURE
EXEC FindVenueBookings 'V0002';

-- Q.1.3. VENUE BOOKING STATUS
-- CORRECTED: Added DISTINCT to remove duplicate rows
SELECT DISTINCT
    VENUES.VENUE_CODE, 
    VENUES.VENUE_NAME, 
    VENUES.ADDRESS, 
    VENUES.CITY, 
    VENUES.MAX_CAPACITY,
    CASE 
        WHEN ACCOMMODATION_BOOKINGS.VENUE_CODE IS NOT NULL THEN 'Bookings recorded'
        ELSE 'No bookings recorded'
    END AS [Booking Status]
FROM VENUES
LEFT JOIN ACCOMMODATION_BOOKINGS 
    ON VENUES.VENUE_CODE = ACCOMMODATION_BOOKINGS.VENUE_CODE;

-- Q.1.4. TOTAL NIGHTS BOOKED PER VENUE
SELECT 
    VENUES.VENUE_NAME, 
    SUM(ACCOMMODATION_BOOKINGS.NIGHTS) AS [TOTAL NIGHTS BOOKED]
FROM VENUES
LEFT JOIN ACCOMMODATION_BOOKINGS 
    ON VENUES.VENUE_CODE = ACCOMMODATION_BOOKINGS.VENUE_CODE
GROUP BY VENUES.VENUE_NAME
ORDER BY [TOTAL NIGHTS BOOKED] DESC;

-- Q.1.5. VENUES WITH NO BOOKINGS
SELECT 
    VENUES.VENUE_NAME
FROM VENUES
LEFT JOIN ACCOMMODATION_BOOKINGS 
    ON VENUES.VENUE_CODE = ACCOMMODATION_BOOKINGS.VENUE_CODE
WHERE ACCOMMODATION_BOOKINGS.VENUE_CODE IS NULL;
