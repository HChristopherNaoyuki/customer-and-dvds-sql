-- QUESTION 2
-- CREATE DATABASE: StudentNumber_DATA6212_ExamQ2
CREATE DATABASE StudentNumber_DATA6212_ExamQ2;

USE StudentNumber_DATA6212_ExamQ2;

-- Q.2.1. TABLE CREATION
CREATE TABLE DVDS
(
    DVD_CODE VARCHAR(5) NOT NULL PRIMARY KEY,
    DVD_TITLE VARCHAR(40) NOT NULL,
    DIRECTOR VARCHAR(40) NOT NULL,
    RELEASE_DATE SMALLDATETIME NOT NULL,
    RUNNING_TIME SMALLINT NOT NULL
);

CREATE TABLE STORES
(
    STORE_CODE VARCHAR(5) NOT NULL PRIMARY KEY,
    STORE_NAME VARCHAR(20) NOT NULL,
    ADDRESS VARCHAR(50) NOT NULL,
    CITY VARCHAR(20) NOT NULL
);

CREATE TABLE AVAILABILITY
(
    DVD_CODE VARCHAR(5) NOT NULL,
    STORE_CODE VARCHAR(5) NOT NULL,
    AVAILABLE_STOCK SMALLINT NOT NULL,
    PRIMARY KEY (DVD_CODE, STORE_CODE),
    FOREIGN KEY (DVD_CODE) REFERENCES DVDS(DVD_CODE),
    FOREIGN KEY (STORE_CODE) REFERENCES STORES(STORE_CODE)
);

-- Q.2.2. POPULATE TABLES
INSERT INTO DVDS (DVD_CODE, DVD_TITLE, DIRECTOR, RELEASE_DATE, RUNNING_TIME)
VALUES 
('D001', 'Joker', 'Todd Phillips', '2019-08-15', 122),
('D002', 'Booksmart', 'Olivia Wilde', '2019-03-10', 105),
('D003', 'Gemini Man', 'Ang Lee', '2019-10-01', 117),
('D004', 'Atlantics', 'Mati Diop', '2019-05-16', 104),
('D005', 'The Farewell', 'Lulu Wang', '2019-01-25', 100);

INSERT INTO STORES (STORE_CODE, STORE_NAME, ADDRESS, CITY)
VALUES 
('ST001', 'DVD Express', '167 Pret Road', 'Johannesburg'),
('ST002', 'DVD Rentals', '5 Second Avenue', 'Port Elizabeth'),
('ST003', 'Movies R Us', '33 Bertha Mkhize Street', 'Durban'),
('ST004', 'Pro Visions DVDs', '27 Bram Fischer Road', 'Durban'),
('ST005', 'Protea DVD Shop', '210 Du Toit Street', 'Pretoria');

INSERT INTO AVAILABILITY (DVD_CODE, STORE_CODE, AVAILABLE_STOCK)
VALUES 
('D002', 'ST001', 13),
('D002', 'ST004', 9),
('D003', 'ST005', 8),
('D004', 'ST003', 5),
('D004', 'ST001', 9);

-- Q.2.3. ADD COLUMN
ALTER TABLE AVAILABILITY
ADD STOCK_ORDERED SMALLINT;

-- Q.2.4. UPDATE STOCK ORDERED
UPDATE AVAILABILITY
SET STOCK_ORDERED = 3
WHERE DVD_CODE = 'D004' AND STORE_CODE = 'ST003';

-- Q.2.5. DVDS NOT AVAILABLE IN ANY STORE
SELECT 
    DVDS.DVD_TITLE, 
    DVDS.DIRECTOR
FROM DVDS
LEFT JOIN AVAILABILITY 
    ON DVDS.DVD_CODE = AVAILABILITY.DVD_CODE
WHERE AVAILABILITY.DVD_CODE IS NULL;

-- Q.2.6. TOTAL AVAILABLE STOCK PER DVD
SELECT 
    DVDS.DVD_TITLE, 
    DVDS.DIRECTOR, 
    SUM(AVAILABILITY.AVAILABLE_STOCK) AS [TOTAL AVAILABLE]
FROM DVDS
LEFT JOIN AVAILABILITY 
    ON DVDS.DVD_CODE = AVAILABILITY.DVD_CODE
GROUP BY DVDS.DVD_TITLE, DVDS.DIRECTOR
ORDER BY DVDS.DVD_TITLE ASC;

-- Q.2.7. STORE WITH MOST D002 STOCK
SELECT TOP 1 
    STORES.STORE_NAME, 
    STORES.ADDRESS, 
    STORES.CITY, 
    DVDS.DVD_TITLE, 
    DVDS.DIRECTOR, 
    AVAILABILITY.AVAILABLE_STOCK
FROM STORES
JOIN AVAILABILITY 
    ON STORES.STORE_CODE = AVAILABILITY.STORE_CODE
JOIN DVDS 
    ON AVAILABILITY.DVD_CODE = DVDS.DVD_CODE
WHERE DVDS.DVD_CODE = 'D002'
ORDER BY AVAILABILITY.AVAILABLE_STOCK DESC;
